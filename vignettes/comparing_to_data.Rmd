---
title: "Comparing model output to data"
author: "Isobel Routledge"
date: "10/5/2020"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE, error=FALSE, message=FALSE, comment=FALSE, warning= FALSE,progress=FALSE, verbose=FALSE}
knitr::opts_chunk$set(warning=FALSE, error=FALSE, message=FALSE, comment=FALSE, warning= FALSE)
```
It is often helpful to check model outputs are consistent with emprirical data and sensible - as sanity checks, model validation and calibration. In this package we provide several datasets and examples of SIMPLEGEN model outputs compared to data to check that key epidemiological relationships are represented consistent with empirical data and data generated from other models. 

## Comparing annual EIR to parasite prevalence 

In order to compare annual EIR to parasite prevalence , we must generate annual EIR estimates, true prevalence estimates and  the expected detected prevalence at a given sampling time. In this example use an expectation for detectibility based on the sum of the probability of detection accross all individuals, but future iterations of the function could be altered to generate the estimated prevalence and bootstrapped confidence intervals by carrying out bernoulli draws based on the mean detectability.

First we run SIMPLEGEN for a range of EIRs by changing the mosquito population size:

```{r, results='hide' }

devtools::load_all("~/GitHub/SIMPLEGEN")

check_SIMPLEGEN_loaded()

 set.seed(134)

 #mosquito population size
m_pop<-c(1e3,2e3,3e3,4e3,5e3,6e3,7e3,8e3,9e3,1e4,2e4,3e4,4e4,5e4,6e4,7e4,8e4,9e4,1e5,2e5)
 
dat<-list()
list_proj<-list()


for(i in 1:length(m_pop)){
  myproj <- simplegen_project()
  myproj <- define_epi_params(myproj,
                              seed_infections = 100,
                              H=1e3,
                              M= m_pop[i],
                              #prob_acute=c(1.0,0.95,0.9,0.85,0.8,0.75,0.7,0.65,0.6,0.55,0.5,0.45,0.4),
                              detectability_microscopy_chronic = 0.45,
                              detectability_PCR_chronic =0.95)
  
  
  myproj <- sim_epi(myproj, max_time=365*10)
  dat[[i]]<- myproj$epi_output$daily_values
  list_proj[[i]]<-myproj
  rm(myproj)
}

```

Then we use the inbuilt function retrieve_prev to retrieve the true prevalence and estimated detected prevalence. We estimate prevalence on a given sampling day and define the type of diagnostic used (PCR or microscopy) andcase detection (active or passive). 

Expected prevalence is calculated by using the sum of the indidvidual probabilities of detection on a given day (A_detectable_microscopy, C_detectable_microscopy,A_detectable_PCR,C_detectable_PCR), divided by the human population size. For example, if there are 100 cases and P(detection by PCR) for all acute and chronic cases = 0.9,and H=1000, then true prevalence = 100/1000 = 0.1, and expected detected prevalence by PCR is 0.9*100/1000 = 0.09. 

We then apply this to the different simulated datasets to create a table of annual EIR and prevalence estimates.

```{r}
EIRprev<-t(sapply(dat,FUN=retrieve_prev, case_detection = "Active", diagnosis = "Microscopy",
                     sampling_time = 3000))
head(EIRprev)

```

Then we can plot on a linear scale using the inbuilt plot_EIR_prevalence function:
```{r, results = 'hide', fig.keep ='all' }
plot_EIR_prevalence(data = EIRprev,scale_x="linear")
 
```

Next we can plot on a log scale:
```{r, warning = FALSE, results = 'hide', fig.keep ='all'}
plot_EIR_prevalence(EIRprev,scale_x="log")


```


